<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFT Toolkit - Item Tracker, Carousel Advisor & Reroll Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 1rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Common Styles */
        .controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .round-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f39c12;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-next { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-undo { background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; }
        .btn-reset { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-restore { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; font-size: 0.9rem; padding: 8px 16px; }
        .btn-clear { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .btn-calculate { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }

        /* Item Grid Styles */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: translateY(-3px);
            border-color: #f39c12;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .item-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .item-card.disabled:hover {
            transform: none;
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        .item-card.selected {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .item-image-container {
            width: 45px;
            height: 45px;
            margin: 0 auto 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
        }

        .item-image {
            width: 35px;
            height: 35px;
            object-fit: contain;
        }

        .item-count-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            border: 2px solid #1a1a2e;
        }

        .item-name {
            text-align: center;
            font-weight: bold;
            font-size: 0.75rem;
            margin-bottom: 4px;
        }

        .item-probability {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            padding: 4px;
            border-radius: 6px;
            margin-top: 4px;
        }

        .prob-high { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .prob-medium { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
        .prob-low { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .section-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #f39c12;
        }

        .history-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Carousel Advisor Styles */
        .combined-item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .combined-item-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .combined-item-card:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .combined-item-card.selected {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.15);
        }

        .combined-item-card .item-image-container {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            font-size: 1.5rem;
        }

        .combined-item-card .item-image {
            width: 40px;
            height: 40px;
        }

        .combined-item-card .item-name {
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .priority-display {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .priority-display h3 {
            color: #2ecc71;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .priority-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 18px;
            border-radius: 10px;
        }

        .priority-rank {
            font-size: 1.6rem;
            font-weight: bold;
            color: #f39c12;
            min-width: 35px;
        }

        .priority-item .item-image-container {
            width: 48px;
            height: 48px;
            margin: 0;
            font-size: 1.4rem;
        }

        .priority-item .item-image {
            width: 40px;
            height: 40px;
        }

        .priority-item .item-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 4px;
        }

        .priority-item .item-name {
            margin: 0;
            text-align: left;
            font-size: 1.05rem;
            font-weight: bold;
        }

        .priority-stats {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #a0a0a0;
            flex-wrap: wrap;
        }

        .stat-item {
            white-space: nowrap;
        }

        .stat-item strong {
            color: #fff;
        }

        .stat-item .need-highlight {
            color: #f39c12;
        }

        .stat-divider {
            color: #555;
        }

        .stat-item.low-chance {
            color: #e74c3c;
        }

        .stat-item.low-chance strong {
            color: #e74c3c;
        }

        .stat-item.high-chance {
            color: #2ecc71;
        }

        .stat-item.high-chance strong {
            color: #2ecc71;
        }

        .stat-item.medium-chance {
            color: #a0a0a0;
        }

        .priority-completes {
            font-size: 0.85rem;
            color: #f39c12;
            margin-top: 4px;
        }

        .priority-toward {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 4px;
        }

        /* Reroll Calculator Styles */
        .calc-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: bold;
            color: #f39c12;
        }

        .form-group select,
        .form-group input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }

        .form-group select option {
            background: #1a1a2e;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f39c12;
        }

        .input-hint {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-top: -4px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .estimate-group {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 10px;
            padding: 12px;
        }

        .estimate-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .estimate-controls select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 0.9rem;
        }

        .estimate-display {
            font-size: 0.85rem;
            color: #9b59b6;
            font-weight: bold;
            padding: 6px 10px;
            background: rgba(155, 89, 182, 0.15);
            border-radius: 6px;
        }

        .estimate-controls.hidden {
            display: none;
        }

        .calc-results {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 20px;
        }

        .calc-results h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .result-card .label {
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .result-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2ecc71;
        }

        .result-card .value.warning {
            color: #f1c40f;
        }

        .result-card .value.danger {
            color: #e74c3c;
        }

        .result-card .sublabel {
            font-size: 0.75rem;
            color: #9b59b6;
            margin-top: 2px;
        }

        .probability-bar {
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* App Layout with Sidebar */
        .app-layout {
            display: flex;
            gap: 20px;
        }

        .main-content {
            flex: 1;
            min-width: 550px;
        }

        /* Sidebars Container - two columns */
        .sidebars-container {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        /* Priority Sidebar (right side) */
        .priority-sidebar {
            width: 250px;
            flex-shrink: 0;
        }

        .priority-sidebar .sidebar-priority-list {
            max-height: none;
        }

        /* Inventory Sidebar */
        /* Component grid: 4 cols √ó 70px + 3 gaps √ó 6px + 24px padding = 322px min */
        /* Build grid: 6 cols √ó 42px + 5 gaps √ó 5px + 24px padding = 301px min */
        .inventory-sidebar {
            width: 470px;
            flex-shrink: 0;
        }

        .sidebar-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: visible;
        }

        .sidebar-title {
            color: #f39c12;
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidebar-title-icon {
            font-size: 1rem;
        }

        /* Component grid - compact icons with tooltips */
        .inv-component-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .inv-component {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 4px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.2s ease;
            position: relative;
        }

        .inv-component:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .inv-component:hover .comp-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .inv-component img {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }

        .inv-component .comp-emoji {
            font-size: 1.4rem;
            width: 28px;
            height: 28px;
            text-align: center;
            line-height: 28px;
        }

        .comp-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            pointer-events: none;
            z-index: 100;
            margin-bottom: 4px;
        }

        .inv-component .count {
            font-weight: bold;
            color: #2ecc71;
            font-size: 0.95rem;
        }

        .inv-component .count.zero {
            color: #555;
        }

        .inv-component-btns {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .inv-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inv-btn:hover {
            transform: scale(1.1);
        }

        .inv-btn-plus {
            background: #27ae60;
            color: white;
        }

        .inv-btn-minus {
            background: #c0392b;
            color: white;
        }

        .inv-btn-minus:disabled {
            background: #444;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Build mode toggle */
        .mode-btn {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #a0a0a0;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .mode-btn.active {
            background: rgba(243, 156, 18, 0.2);
            border-color: #f39c12;
            color: #f39c12;
        }

        /* Build grid - 36 items in 6x6 grid */
        /* Fixed 42px items: 6√ó42 + 5√ó5 gaps = 277px, fits in 286px (310-24 padding) */
        .build-grid {
            display: grid;
            grid-template-columns: repeat(6, 42px);
            gap: 5px;
            justify-content: center;
        }

        .build-item {
            width: 42px;
            height: 42px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px;
            transition: all 0.2s ease;
            position: relative;
        }

        .build-item.buildable {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.15);
        }

        .build-item.buildable:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
        }

        .build-item.not-buildable {
            opacity: 0.35;
            cursor: not-allowed;
        }

        /* Add mode styling */
        .build-item.add-mode {
            border-color: #9b59b6;
            background: rgba(155, 89, 182, 0.15);
            opacity: 1;
            cursor: pointer;
        }

        .build-item.add-mode:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        .build-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .build-item .build-emoji {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        /* Built items list */
        .built-items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            min-height: 30px;
        }

        .built-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(46, 204, 113, 0.2);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .built-item img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .built-item .remove-built {
            cursor: pointer;
            color: #e74c3c;
            font-weight: bold;
            margin-left: 4px;
        }

        .built-item .remove-built:hover {
            color: #c0392b;
        }

        /* Sidebar Priority List */
        .sidebar-priority {
            border-color: rgba(46, 204, 113, 0.3);
        }

        .sidebar-priority-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .sidebar-priority-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .sidebar-priority-item.high-priority {
            background: rgba(243, 156, 18, 0.15);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .sidebar-priority-item .rank {
            font-weight: bold;
            color: #f39c12;
            font-size: 0.85rem;
            min-width: 24px;
            padding-top: 2px;
        }

        .sidebar-priority-item img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .sidebar-priority-item .info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-priority-item .name {
            font-size: 0.85rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 2px;
        }

        .sidebar-priority-item .details {
            font-size: 0.7rem;
            color: #a0a0a0;
            line-height: 1.4;
        }

        .sidebar-priority-item .details .finish {
            color: #f39c12;
        }

        .sidebar-priority-item .stat-item {
            white-space: nowrap;
        }

        .sidebar-priority-item .stat-divider {
            color: #555;
        }

        .sidebar-priority-item .need-highlight {
            color: #f39c12;
        }

        .sidebar-priority-item .low-chance strong {
            color: #e74c3c;
        }

        .sidebar-priority-item .high-chance strong {
            color: #2ecc71;
        }

        .sidebar-ready-banner {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
        }

        .sidebar-ready-banner .label {
            color: #2ecc71;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .sidebar-ready-banner .items {
            color: #fff;
            font-size: 0.75rem;
            margin-top: 2px;
        }

        /* Carousel advisor status badges */
        .combined-item-card {
            position: relative;
        }

        .combined-item-card.ready {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.15);
        }

        .combined-item-card.one-away {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        /* Built items are still fully selectable - just show count badge */

        .status-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-ready {
            background: #2ecc71;
            color: white;
        }

        .badge-one-away {
            background: #f39c12;
            color: white;
        }

        .badge-built {
            background: #7f8c8d;
            color: white;
        }

        /* Priority item enhancements */
        .priority-item .completes-info {
            font-size: 0.75rem;
            color: #f39c12;
            margin-top: 2px;
        }

        .priority-item.high-priority {
            background: rgba(243, 156, 18, 0.15);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        /* Comps Sidebar (Left) */
        .comps-sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .comps-sidebar .sidebar-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .comps-sidebar .sidebar-title {
            color: #9b59b6;
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-new-comp {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-new-comp:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
        }

        .comps-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
        }

        .comp-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .comp-card:hover {
            border-color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
        }

        .comp-card.active {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .comp-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .comp-name {
            font-weight: bold;
            font-size: 0.85rem;
            color: #fff;
            flex: 1;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .comp-edit-btn {
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 0.75rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .comp-edit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .comp-items-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .comp-items-preview img {
            width: 22px;
            height: 22px;
            object-fit: contain;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
        }

        .comp-items-count {
            font-size: 0.7rem;
            color: #a0a0a0;
            margin-top: 4px;
        }

        .no-comps-msg {
            color: #a0a0a0;
            font-size: 0.8rem;
            text-align: center;
            padding: 10px;
        }

        /* Comp Modal */
        .comp-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .comp-modal-overlay.show {
            display: flex;
        }

        .comp-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid rgba(155, 89, 182, 0.5);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .comp-modal h3 {
            color: #9b59b6;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .comp-modal-field {
            margin-bottom: 20px;
        }

        .comp-modal-field label {
            display: block;
            color: #f39c12;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .comp-modal-field input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
        }

        .comp-modal-field input:focus {
            outline: none;
            border-color: #9b59b6;
        }

        .comp-item-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .comp-item-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
        }

        .comp-item-option:hover {
            border-color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
        }

        .comp-item-option.selected {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.15);
        }

        .comp-item-option img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        .comp-item-option .item-label {
            font-size: 0.65rem;
            color: #a0a0a0;
            text-align: center;
            line-height: 1.2;
        }

        .comp-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .comp-modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-save-comp {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-cancel-comp {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-delete-comp {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            margin-right: auto;
        }

        .comp-modal-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .app-layout {
                flex-direction: column;
            }
            .comps-sidebar {
                width: 100%;
                order: -1;
            }
            .comps-sidebar .comps-list {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                max-height: none;
            }
            .comps-sidebar .comp-card {
                flex: 0 0 auto;
                width: auto;
                min-width: 150px;
            }
            .sidebars-container {
                width: 100%;
            }
            .inventory-sidebar {
                width: auto;
                flex: 1;
            }
            .priority-sidebar {
                width: auto;
                flex: 1;
            }
            .inv-component-grid {
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                gap: 8px;
            }
            .build-grid {
                grid-template-columns: repeat(12, 42px);
            }
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .tab-btn { padding: 10px; font-size: 0.85rem; }
            .item-grid { grid-template-columns: repeat(2, 1fr); }
            .combined-item-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .controls { flex-direction: column; align-items: stretch; }
            .button-group { justify-content: center; }
            .comps-sidebar .comps-list {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            .sidebars-container {
                flex-direction: column;
            }
            .priority-sidebar {
                width: 100%;
            }
            .inv-component-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .build-grid {
                grid-template-columns: repeat(6, 42px);
            }
            .comp-item-selector {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TFT Toolkit</h1>
            <p class="subtitle">Item Tracker, Carousel Advisor & Reroll Calculator - Set 16</p>
        </header>

        <div class="app-layout">
            <!-- Comps Sidebar (Left) -->
            <div class="comps-sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <span class="sidebar-title-icon">üìã</span>
                        My Comps
                    </div>
                    <button class="btn-new-comp" onclick="openCompModal()">+ New Comp</button>
                    <div class="comps-list" id="compsList">
                        <div class="no-comps-msg">No saved comps yet</div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <!-- Tab Navigation -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('tracker')">Item Tracker</button>
                    <button class="tab-btn" onclick="switchTab('carousel')">Carousel Advisor</button>
                    <button class="tab-btn" onclick="switchTab('reroll')">Reroll Calculator</button>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <!-- Tab 1: Item Tracker -->
                <div id="tab-tracker" class="tab-content active">
                    <div class="controls">
                        <div class="round-indicator">Round <span id="currentRound">1</span>/3</div>
                        <div class="button-group">
                            <button class="btn-next" id="nextRoundBtn" onclick="nextRound()">Next Round</button>
                            <button class="btn-undo" id="undoBtn" onclick="undoLastLoot()" disabled>Undo</button>
                            <button class="btn-reset" onclick="resetGame()">Reset Game</button>
                        </div>
                    </div>

                    <div class="item-grid" id="itemGrid"></div>

                    <div class="section-box">
                        <div class="section-title">Game History (Last 2 Games)</div>
                        <div class="history-buttons" id="historyButtons">
                            <p style="color: #a0a0a0;">No saved games yet</p>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Carousel Advisor -->
                <div id="tab-carousel" class="tab-content">
                    <div class="section-box">
                        <div class="section-title">Select Items You Want to Build</div>
                        <p style="color: #a0a0a0; margin-bottom: 15px;">Click on combined items to mark them as targets. The advisor will show which base components to prioritize on carousel.</p>
                        <button class="btn-clear" onclick="clearSelectedItems()" style="margin-bottom: 15px;">Clear Selection</button>
                        <div class="combined-item-grid" id="combinedItemGrid"></div>
                    </div>

                    <div class="priority-display" id="priorityDisplay">
                        <h3>Carousel Priority</h3>
                        <p style="color: #a0a0a0;">Select target items above to see component priorities.</p>
                        <div class="priority-list" id="priorityList"></div>
                    </div>
                </div>

                <!-- Tab 3: Reroll Calculator -->
                <div id="tab-reroll" class="tab-content">
                    <div class="section-box">
                        <div class="section-title">Champion Hit Calculator</div>
                        <div class="calc-form">
                            <div class="form-group">
                                <label>Your Level</label>
                                <select id="calcLevel">
                                    <option value="2">Level 2</option>
                                    <option value="3">Level 3</option>
                                    <option value="4">Level 4</option>
                                    <option value="5">Level 5</option>
                                    <option value="6">Level 6</option>
                                    <option value="7" selected>Level 7</option>
                                    <option value="8">Level 8</option>
                                    <option value="9">Level 9</option>
                                    <option value="10">Level 10</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Champion Cost</label>
                                <select id="calcCost">
                                    <option value="1">1-cost (30 in pool)</option>
                                    <option value="2">2-cost (25 in pool)</option>
                                    <option value="3" selected>3-cost (18 in pool)</option>
                                    <option value="4">4-cost (10 in pool)</option>
                                    <option value="5">5-cost (9 in pool)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Copies You Own</label>
                                <input type="number" id="calcOwned" min="0" max="8" value="0">
                            </div>
                            <div class="form-group">
                                <label>Known Copies Out</label>
                                <input type="number" id="calcOut" min="0" max="30" value="0">
                                <span class="input-hint">Copies you've seen on other boards</span>
                            </div>
                            <div class="form-group estimate-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="calcUseEstimate" checked>
                                    Estimate units held by others
                                </label>
                                <div class="estimate-controls" id="estimateControls">
                                    <select id="calcContested">
                                        <option value="1">Not contested (1x)</option>
                                        <option value="1.5">Slightly contested (1.5x)</option>
                                        <option value="2">Heavily contested (2x)</option>
                                    </select>
                                    <div class="estimate-display" id="estimateDisplay">
                                        Est. ~0 copies held by others
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Target</label>
                                <select id="calcTarget">
                                    <option value="3">2-star (need 3 copies)</option>
                                    <option value="9">3-star (need 9 copies)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Gold to Spend</label>
                                <input type="number" id="calcGold" min="0" max="200" value="50">
                            </div>
                        </div>
                        <button class="btn-calculate" onclick="calculateReroll()">Calculate Odds</button>
                    </div>

                    <div class="calc-results" id="calcResults" style="display: none;">
                        <h3>Results</h3>
                        <div class="result-grid" id="resultGrid"></div>
                        <div class="probability-bar">
                            <div class="probability-fill" id="probabilityFill" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>
            </div><!-- end main-content -->

            <!-- Sidebars Container -->
            <div class="sidebars-container">
                <!-- Inventory Sidebar -->
                <div class="inventory-sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <span class="sidebar-title-icon">üéí</span>
                            My Components
                        </div>
                        <p style="color: #a0a0a0; font-size: 0.8rem; margin-bottom: 10px;">+/- to add from carousel/augments</p>
                        <div class="inv-component-grid" id="invComponentGrid"></div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <span class="sidebar-title-icon" id="buildModeIcon">üî®</span>
                            <span id="buildModeTitle">Build Item</span>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <button class="mode-btn active" id="buildModeBtn" onclick="setBuildMode('build')">Build</button>
                            <button class="mode-btn" id="addModeBtn" onclick="setBuildMode('add')">Add (Augment/Anvil)</button>
                        </div>
                        <p style="color: #a0a0a0; font-size: 0.8rem; margin-bottom: 10px;" id="buildModeHint">Click buildable items (green border)</p>
                        <div class="build-grid" id="buildGrid"></div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">
                            <span class="sidebar-title-icon">‚öîÔ∏è</span>
                            My Items
                        </div>
                        <div class="built-items-list" id="builtItemsList">
                            <span style="color: #a0a0a0; font-size: 0.85rem;">None yet</span>
                        </div>
                    </div>

                    <button class="btn-clear" onclick="clearInventory()" style="width: 100%; margin-top: 5px;">Clear Inventory</button>
                </div>

                <!-- Priority Sidebar -->
                <div class="priority-sidebar">
                    <div class="sidebar-section sidebar-priority">
                        <div class="sidebar-title">
                            <span class="sidebar-title-icon">üéØ</span>
                            Carousel Priority
                        </div>
                        <div class="sidebar-priority-list" id="sidebarPriorityList">
                            <span style="color: #a0a0a0; font-size: 0.85rem;">Select items in Carousel Advisor</span>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- end app-layout -->
    </div>

    <!-- Comp Modal -->
    <div class="comp-modal-overlay" id="compModalOverlay" onclick="closeCompModal(event)">
        <div class="comp-modal" onclick="event.stopPropagation()">
            <h3 id="compModalTitle">New Comp</h3>
            <div class="comp-modal-field">
                <label for="compNameInput">Comp Name</label>
                <input type="text" id="compNameInput" placeholder="e.g., Bilgewater Miss Fortune Tahm Kench (Fast 9)" maxlength="60">
            </div>
            <div class="comp-modal-field">
                <label>Select Items (up to 15)</label>
                <div class="comp-item-selector" id="compItemSelector"></div>
            </div>
            <div class="comp-modal-buttons">
                <button class="btn-delete-comp" id="deleteCompBtn" onclick="deleteComp()" style="display: none;">Delete</button>
                <button class="btn-cancel-comp" onclick="closeCompModal()">Cancel</button>
                <button class="btn-save-comp" onclick="saveComp()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================

        // Base Items
        const ITEMS = [
            { id: 'bf-sword', name: 'B.F. Sword', emoji: '‚öîÔ∏è', image: 'images/B._F._Sword_TFT_item.webp' },
            { id: 'recurve-bow', name: 'Recurve Bow', emoji: 'üèπ', image: 'images/Recurve_Bow_TFT_item.webp' },
            { id: 'rod', name: 'Needlessly Large Rod', emoji: 'üîÆ', image: 'images/Needlessly_Large_Rod_TFT_item.webp' },
            { id: 'tear', name: 'Tear of the Goddess', emoji: 'üíß', image: 'images/Tear_of_the_Goddess_TFT_item.webp' },
            { id: 'chain-vest', name: 'Chain Vest', emoji: 'üõ°Ô∏è', image: 'images/Chain_Vest_TFT_item.webp' },
            { id: 'cloak', name: 'Negatron Cloak', emoji: 'üß•', image: 'images/Negatron_Cloak_TFT_item.webp' },
            { id: 'belt', name: "Giant's Belt", emoji: 'üí™', image: 'images/Giants_Belt_TFT_item.webp' },
            { id: 'gloves', name: 'Sparring Gloves', emoji: 'ü•ä', image: 'images/Sparring_Gloves_TFT_item.webp' }
        ];

        // Combined Items (all 36 combinations) - Updated for Set 16 with actual file paths
        const COMBINED_ITEMS = [
            // BF Sword combinations
            { id: 'deathblade', name: 'Deathblade', components: ['bf-sword', 'bf-sword'], image: 'images/Deathblade_TFT_item.webp' },
            { id: 'giant-slayer', name: 'Giant Slayer', components: ['bf-sword', 'recurve-bow'], image: 'images/Giant_Slayer_item.webp' },
            { id: 'hextech-gunblade', name: 'Hextech Gunblade', components: ['bf-sword', 'rod'], image: 'images/Hextech_Gunblade_TFT_item.webp' },
            { id: 'spear-of-shojin', name: 'Spear of Shojin', components: ['bf-sword', 'tear'], image: 'images/Spear_of_Shojin_TFT_item.webp' },
            { id: 'edge-of-night', name: 'Edge of Night', components: ['bf-sword', 'chain-vest'], image: 'images/Edge_of_Night.png' },
            { id: 'bloodthirster', name: 'Bloodthirster', components: ['bf-sword', 'cloak'], image: 'images/Bloodthirster_TFT_item.webp' },
            { id: 'steraks-gage', name: "Sterak's Gage", components: ['bf-sword', 'belt'], image: "images/Sterak%2527s_Gage_TFT_item.webp" },
            { id: 'infinity-edge', name: 'Infinity Edge', components: ['bf-sword', 'gloves'], image: 'images/Infinity_Edge_TFT_item.webp' },
            // Recurve Bow combinations
            { id: 'red-buff', name: 'Red Buff', components: ['recurve-bow', 'recurve-bow'], image: 'images/Red_Buff_TFT_item.webp' },
            { id: 'guinsoos-rageblade', name: "Guinsoo's Rageblade", components: ['recurve-bow', 'rod'], image: "images/Guinsoo%2527s_Rageblade_item.webp" },
            { id: 'void-staff', name: 'Void Staff', components: ['recurve-bow', 'tear'], image: 'images/Void_Staff.png' },
            { id: 'titans-resolve', name: "Titan's Resolve", components: ['recurve-bow', 'chain-vest'], image: "images/Titan%2527s_Resolve_TFT_item.webp" },
            { id: 'krakens-fury', name: "Kraken's Fury", components: ['recurve-bow', 'cloak'], image: 'images/Kraken_Fury.png' },
            { id: 'nashors-tooth', name: "Nashor's Tooth", components: ['recurve-bow', 'belt'], image: "images/Nashor%2527s_Tooth_TFT_item.webp" },
            { id: 'last-whisper', name: 'Last Whisper', components: ['recurve-bow', 'gloves'], image: 'images/Last_Whisper_item_old.webp' },
            // Rod combinations
            { id: 'rabadons-deathcap', name: "Rabadon's Deathcap", components: ['rod', 'rod'], image: "images/Rabadon%2527s_Deathcap_TFT_item.webp" },
            { id: 'archangels-staff', name: "Archangel's Staff", components: ['rod', 'tear'], image: "images/Archangel%2527s_Staff_TFT_item.webp" },
            { id: 'crownguard', name: 'Crownguard', components: ['rod', 'chain-vest'], image: 'images/Crownguard_TFT_item.webp' },
            { id: 'ionic-spark', name: 'Ionic Spark', components: ['rod', 'cloak'], image: 'images/Ionic_Spark_TFT_item.webp' },
            { id: 'morellonomicon', name: 'Morellonomicon', components: ['rod', 'belt'], image: 'images/Morellonomicon_TFT_item.webp' },
            { id: 'jeweled-gauntlet', name: 'Jeweled Gauntlet', components: ['rod', 'gloves'], image: 'images/Jeweled_Gauntlet_TFT_item.webp' },
            // Tear combinations
            { id: 'blue-buff', name: 'Blue Buff', components: ['tear', 'tear'], image: 'images/Blue_Buff_TFT_item.webp' },
            { id: 'protectors-vow', name: "Protector's Vow", components: ['tear', 'chain-vest'], image: "images/Protector%2527s_Vow_TFT_item.webp" },
            { id: 'adaptive-helm', name: 'Adaptive Helm', components: ['tear', 'cloak'], image: 'images/Adaptive_Helm_TFT_item.webp' },
            { id: 'spirit-visage', name: 'Spirit Visage', components: ['tear', 'belt'], image: 'images/Spirit_Visage.png' },
            { id: 'hand-of-justice', name: 'Hand of Justice', components: ['tear', 'gloves'], image: 'images/Hand_of_Justice_TFT_item.webp' },
            // Chain Vest combinations
            { id: 'bramble-vest', name: 'Bramble Vest', components: ['chain-vest', 'chain-vest'], image: 'images/Bramble_Vest_TFT_item.webp' },
            { id: 'gargoyle-stoneplate', name: 'Gargoyle Stoneplate', components: ['chain-vest', 'cloak'], image: 'images/Gargoyle_Stoneplate_TFT_item.webp' },
            { id: 'sunfire-cape', name: 'Sunfire Cape', components: ['chain-vest', 'belt'], image: 'images/Sunfire_Cape_TFT_item.webp' },
            { id: 'steadfast-heart', name: 'Steadfast Heart', components: ['chain-vest', 'gloves'], image: 'images/Steadfast_Heart_TFT_item.webp' },
            // Negatron Cloak combinations
            { id: 'dragons-claw', name: "Dragon's Claw", components: ['cloak', 'cloak'], image: "images/Dragon%2527s_Claw_TFT_item.webp" },
            { id: 'evenshroud', name: 'Evenshroud', components: ['cloak', 'belt'], image: 'images/Evenshroud_TFT_item.webp' },
            { id: 'quicksilver', name: 'Quicksilver', components: ['cloak', 'gloves'], image: 'images/Quicksilver_TFT_item.webp' },
            // Giant's Belt combinations
            { id: 'warmogs-armor', name: "Warmog's Armor", components: ['belt', 'belt'], image: "images/32px-Warmog's_Armor_WR_item.png" },
            { id: 'strikers-flail', name: "Striker's Flail", components: ['belt', 'gloves'], image: 'images/Strikers_Flail.avif' },
            // Sparring Gloves combination
            { id: 'thiefs-gloves', name: "Thief's Gloves", components: ['gloves', 'gloves'], image: "images/Thief%2527s_Gloves_TFT_item.webp" }
        ];

        // Reroll Calculator Data (Set 16)
        const POOL_SIZES = { 1: 30, 2: 25, 3: 18, 4: 10, 5: 9 };
        const CHAMPIONS_PER_TIER = { 1: 13, 2: 13, 3: 13, 4: 12, 5: 8 };

        const ROLL_ODDS = {
            2:  [100, 0, 0, 0, 0],
            3:  [75, 25, 0, 0, 0],
            4:  [55, 30, 15, 0, 0],
            5:  [45, 33, 20, 2, 0],
            6:  [30, 40, 25, 5, 0],
            7:  [19, 30, 40, 10, 1],
            8:  [15, 20, 32, 30, 3],
            9:  [10, 17, 25, 33, 15],
            10: [5, 10, 20, 40, 25]
        };

        // Estimated total copies of each tier held by other 7 players combined
        // Calculated from: board size √ó copies/unit √ó tier distribution
        // Assumptions per level:
        //   - 7 other players with board size = level
        //   - Star distribution evolves: early ~1.3 copies/unit, late ~2.8 copies/unit
        //   - Tier distribution shifts from 1-costs early to 4-5 costs late
        // Format: [1-cost, 2-cost, 3-cost, 4-cost, 5-cost]
        const ESTIMATED_TIER_COPIES_HELD = {
            // Level 2 (Stage 1): 7√ó2 units, ~1.2 copies/unit, 80% 1-cost 20% 2-cost
            2:  [13, 3, 0, 0, 0],
            // Level 3 (Stage 2 start): 7√ó3 units, ~1.4 copies/unit, 70% 1c 30% 2c
            3:  [21, 9, 0, 0, 0],
            // Level 4 (Stage 2): 7√ó4 units, ~1.8 copies/unit, rolling for 2-stars
            4:  [28, 18, 4, 0, 0],
            // Level 5 (Stage 3 start): 7√ó5 units, ~2.0 copies/unit, 3-costs coming
            5:  [28, 28, 12, 2, 0],
            // Level 6 (Stage 3-4): 7√ó6 units, ~2.2 copies/unit, 4-costs appearing
            6:  [26, 36, 24, 8, 1],
            // Level 7 (Stage 4): 7√ó7 units, ~2.4 copies/unit, peak 3-cost usage
            7:  [24, 40, 38, 16, 2],
            // Level 8 (Stage 4-5): 7√ó8 units, ~2.6 copies/unit, 4-costs contested
            8:  [20, 42, 50, 34, 10],
            // Level 9 (Stage 5+): 7√ó9 units, ~2.8 copies/unit, 5-costs appearing
            9:  [16, 40, 56, 52, 24],
            // Level 10 (Late Stage 5+): 7√ó10 units, ~3.0 copies/unit, 4-5 cost heavy
            10: [12, 36, 58, 66, 38]
        };

        // ==================== STATE ====================

        // Item Tracker State
        let currentRound = 1;
        let itemCounts = {};
        let lootHistory = [];
        let gameHistory = [];

        // Carousel Advisor State
        let selectedCombinedItems = new Set();

        // Inventory State
        let inventory = {
            components: {},
            combinedItems: []
        };
        let buildMode = 'build'; // 'build' or 'add'

        // Saved Comps State
        let savedComps = [];
        let editingCompId = null; // Track which comp is being edited in modal

        // ==================== TAB NAVIGATION ====================

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ==================== ITEM TRACKER ====================

        function initTracker(skipReset = false) {
            // Only reset itemCounts if not loaded from localStorage
            if (!skipReset) {
                ITEMS.forEach(item => {
                    itemCounts[item.id] = 0;
                });
            }
            renderItems();
            updateProbabilities();
            updateHistoryDisplay();
        }

        function renderItems() {
            const grid = document.getElementById('itemGrid');
            grid.innerHTML = '';

            ITEMS.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.id = `item-${item.id}`;
                card.onclick = () => lootItem(item.id);

                const count = itemCounts[item.id];
                const countBadge = count > 0 ? `<div class="item-count-badge">${count}</div>` : '';

                card.innerHTML = `
                    <div class="item-image-container">
                        <img class="item-image" src="${item.image}" alt="${item.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="item-emoji" style="display:none; font-size:2.5rem; align-items:center; justify-content:center; width:60px; height:60px;">${item.emoji}</div>
                        ${countBadge}
                    </div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-probability" id="prob-${item.id}">0.0%</div>
                `;

                grid.appendChild(card);
            });
        }

        function calculateProbabilities() {
            const probabilities = {};
            let totalInBag = 0;

            ITEMS.forEach(item => {
                const inBag = currentRound - (itemCounts[item.id] || 0);
                probabilities[item.id] = Math.max(0, inBag);
                totalInBag += probabilities[item.id];
            });

            ITEMS.forEach(item => {
                if (totalInBag > 0) {
                    probabilities[item.id] = (probabilities[item.id] / totalInBag) * 100;
                } else {
                    probabilities[item.id] = 0;
                }
            });

            return probabilities;
        }

        function updateProbabilities() {
            const probabilities = calculateProbabilities();

            ITEMS.forEach(item => {
                const probElement = document.getElementById(`prob-${item.id}`);
                const cardElement = document.getElementById(`item-${item.id}`);
                const prob = probabilities[item.id];

                probElement.textContent = prob.toFixed(1) + '%';

                probElement.className = 'item-probability';
                if (prob > 15) {
                    probElement.classList.add('prob-high');
                } else if (prob >= 10) {
                    probElement.classList.add('prob-medium');
                } else {
                    probElement.classList.add('prob-low');
                }

                if (itemCounts[item.id] >= currentRound) {
                    cardElement.classList.add('disabled');
                } else {
                    cardElement.classList.remove('disabled');
                }
            });
        }

        function lootItem(itemId) {
            const currentCount = itemCounts[itemId];

            if (currentCount >= currentRound) {
                const item = ITEMS.find(i => i.id === itemId);
                showError(`Cannot loot ${item.name} - maximum reached for Round ${currentRound}`);
                return;
            }

            itemCounts[itemId]++;
            lootHistory.push(itemId);

            // Also add to inventory
            inventory.components[itemId] = (inventory.components[itemId] || 0) + 1;

            renderItems();
            updateProbabilities();
            updateUndoButton();
            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        function undoLastLoot() {
            if (lootHistory.length === 0) return;

            const lastItem = lootHistory.pop();
            itemCounts[lastItem]--;

            // Also remove from inventory
            inventory.components[lastItem] = Math.max(0, (inventory.components[lastItem] || 0) - 1);

            renderItems();
            updateProbabilities();
            updateUndoButton();
            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            undoBtn.disabled = lootHistory.length === 0;
        }

        function nextRound() {
            if (currentRound >= 3) {
                showError('Already at maximum round (3)');
                return;
            }

            currentRound++;
            document.getElementById('currentRound').textContent = currentRound;

            const nextBtn = document.getElementById('nextRoundBtn');
            if (currentRound >= 3) {
                nextBtn.disabled = true;
                nextBtn.textContent = 'Max Round Reached';
            }

            updateProbabilities();
        }

        function resetGame() {
            const confirmed = confirm('Reset game? This will save the current game to history and clear inventory.');
            if (!confirmed) return;

            const gameState = {
                round: currentRound,
                items: { ...itemCounts },
                lootHistory: [...lootHistory],
                timestamp: new Date().toLocaleString()
            };

            gameHistory.unshift(gameState);
            if (gameHistory.length > 2) {
                gameHistory = gameHistory.slice(0, 2);
            }

            currentRound = 1;
            itemCounts = {};
            lootHistory = [];

            ITEMS.forEach(item => {
                itemCounts[item.id] = 0;
            });

            // Also clear inventory
            initInventory();

            // Clear Carousel Advisor selections (new game, new comp)
            selectedCombinedItems.clear();

            document.getElementById('currentRound').textContent = currentRound;
            const nextBtn = document.getElementById('nextRoundBtn');
            nextBtn.disabled = false;
            nextBtn.textContent = 'Next Round';

            renderItems();
            updateProbabilities();
            updateUndoButton();
            updateHistoryDisplay();
            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        function restoreGame(index) {
            if (index >= gameHistory.length) return;

            const confirmed = confirm('Restore this game? Current progress will be lost.');
            if (!confirmed) return;

            const savedGame = gameHistory[index];

            currentRound = savedGame.round;
            itemCounts = { ...savedGame.items };
            lootHistory = [...savedGame.lootHistory];

            document.getElementById('currentRound').textContent = currentRound;
            const nextBtn = document.getElementById('nextRoundBtn');
            if (currentRound >= 3) {
                nextBtn.disabled = true;
                nextBtn.textContent = 'Max Round Reached';
            } else {
                nextBtn.disabled = false;
                nextBtn.textContent = 'Next Round';
            }

            renderItems();
            updateProbabilities();
            updateUndoButton();
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('historyButtons');

            if (gameHistory.length === 0) {
                historyDiv.innerHTML = '<p style="color: #a0a0a0;">No saved games yet</p>';
                return;
            }

            historyDiv.innerHTML = '';
            gameHistory.forEach((game, index) => {
                const button = document.createElement('button');
                button.className = 'btn-restore';
                button.textContent = `Game ${index + 1} (Round ${game.round}) - ${game.timestamp}`;
                button.onclick = () => restoreGame(index);
                historyDiv.appendChild(button);
            });
        }

        // ==================== CAROUSEL ADVISOR ====================

        function initCarouselAdvisor() {
            renderCombinedItems();
        }

        function renderCombinedItems() {
            const grid = document.getElementById('combinedItemGrid');
            grid.innerHTML = '';

            COMBINED_ITEMS.forEach(item => {
                const card = document.createElement('div');
                const status = getItemBuildStatus(item.id);
                const isSelected = selectedCombinedItems.has(item.id);
                const builtCount = inventory.combinedItems.filter(id => id === item.id).length;

                let statusClass = '';
                let badgeHtml = '';

                // Show built count badge (doesn't prevent selection)
                if (builtCount > 0) {
                    badgeHtml = `<span class="status-badge badge-built">Have ${builtCount}</span>`;
                }

                // Show ready/one-away badges for selected items (overrides "have" badge)
                if (isSelected) {
                    if (status === 'ready') {
                        statusClass = 'ready';
                        badgeHtml = builtCount > 0
                            ? `<span class="status-badge badge-ready">${builtCount}+ Ready</span>`
                            : '<span class="status-badge badge-ready">Ready!</span>';
                    } else if (status === 'one-away') {
                        statusClass = 'one-away';
                        badgeHtml = builtCount > 0
                            ? `<span class="status-badge badge-one-away">${builtCount}+ 1 Away</span>`
                            : '<span class="status-badge badge-one-away">1 Away</span>';
                    }
                }

                card.className = 'combined-item-card' + (isSelected ? ' selected' : '') + (statusClass ? ' ' + statusClass : '');
                card.onclick = () => toggleCombinedItem(item.id);

                card.innerHTML = `
                    ${badgeHtml}
                    <div class="item-image-container">
                        <img class="item-image" src="${item.image}" alt="${item.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size:1.5rem;\\'>üì¶</span>';">
                    </div>
                    <div class="item-name">${item.name}</div>
                `;

                grid.appendChild(card);
            });
        }

        function toggleCombinedItem(itemId) {
            if (selectedCombinedItems.has(itemId)) {
                selectedCombinedItems.delete(itemId);
            } else {
                selectedCombinedItems.add(itemId);
            }
            renderCombinedItems();
            updatePriorityDisplay();
            renderCompsSidebar();
        }

        function clearSelectedItems() {
            selectedCombinedItems.clear();
            renderCombinedItems();
            renderCompsSidebar();
            updatePriorityDisplay();
        }

        function updatePriorityDisplay() {
            const priorityList = document.getElementById('priorityList');
            const sidebarList = document.getElementById('sidebarPriorityList');

            if (selectedCombinedItems.size === 0) {
                priorityList.innerHTML = '';
                sidebarList.innerHTML = '<span style="color: #a0a0a0; font-size: 0.85rem;">Select items in Carousel Advisor</span>';
                return;
            }

            // Get creep round probabilities
            const creepProbabilities = calculateProbabilities();

            // Calculate component scores with smart inventory-aware scoring
            const componentScores = {};
            const componentCompletes = {}; // Track which items each component completes
            const readyToBuild = []; // Items that can be built now

            ITEMS.forEach(item => {
                componentScores[item.id] = 0;
                componentCompletes[item.id] = [];
            });

            selectedCombinedItems.forEach(itemId => {
                // Don't skip built items - user might want multiple copies
                const item = COMBINED_ITEMS.find(i => i.id === itemId);
                const [c1, c2] = item.components;
                const owned1 = inventory.components[c1] || 0;
                const owned2 = inventory.components[c2] || 0;

                if (c1 === c2) {
                    // Same component (e.g., Deathblade = BF + BF)
                    if (owned1 >= 2) {
                        readyToBuild.push(item.name);
                    } else if (owned1 === 1) {
                        // One away - HIGH priority
                        componentScores[c1] += 3;
                        componentCompletes[c1].push(item.name);
                    } else {
                        // Need 2 - normal priority (count as 2)
                        componentScores[c1] += 2;
                    }
                } else {
                    // Different components
                    if (owned1 > 0 && owned2 > 0) {
                        readyToBuild.push(item.name);
                    } else if (owned1 > 0) {
                        // Have c1, need c2 - HIGH priority for c2
                        componentScores[c2] += 3;
                        componentCompletes[c2].push(item.name);
                    } else if (owned2 > 0) {
                        // Have c2, need c1 - HIGH priority for c1
                        componentScores[c1] += 3;
                        componentCompletes[c1].push(item.name);
                    } else {
                        // Need both - normal priority
                        componentScores[c1] += 1;
                        componentScores[c2] += 1;
                    }
                }
            });

            // Apply scarcity bonus based on creep probabilities
            // Lower probability from creeps = higher priority on carousel
            // Formula: finalScore = baseScore * (1 + scarcityFactor)
            // scarcityFactor = (maxProb - itemProb) / maxProb (ranges 0 to 1)
            const maxProbability = Math.max(...Object.values(creepProbabilities), 1);
            const finalScores = {};

            Object.entries(componentScores).forEach(([compId, baseScore]) => {
                if (baseScore > 0) {
                    const prob = creepProbabilities[compId] || 0;
                    // Scarcity: 1.0 when prob is 0%, 0.0 when prob is max
                    const scarcityFactor = 1 - (prob / maxProbability);
                    // Boost score by up to 50% for scarce items
                    finalScores[compId] = baseScore * (1 + scarcityFactor * 0.5);
                }
            });

            // Sort by final score (higher = more important)
            const sorted = Object.entries(finalScores)
                .sort((a, b) => b[1] - a[1]);

            priorityList.innerHTML = '';

            // Show ready-to-build items first
            if (readyToBuild.length > 0) {
                const readyDiv = document.createElement('div');
                readyDiv.style.cssText = 'background: rgba(46,204,113,0.15); border: 1px solid rgba(46,204,113,0.3); border-radius: 10px; padding: 12px 15px; margin-bottom: 15px;';
                readyDiv.innerHTML = `
                    <div style="color: #2ecc71; font-weight: bold; margin-bottom: 5px; font-size: 1rem;">Ready to Build:</div>
                    <div style="color: #fff; font-size: 0.95rem;">${readyToBuild.join(', ')}</div>
                `;
                priorityList.appendChild(readyDiv);
            }

            if (sorted.length === 0 && readyToBuild.length === 0) {
                priorityList.innerHTML = '<p style="color: #a0a0a0; font-size: 1rem;">No components needed - all selected items are ready to build!</p>';
                renderSidebarPriority(sorted, componentCompletes, readyToBuild, creepProbabilities);
                return;
            }

            if (sorted.length === 0) {
                // Only had ready-to-build items
                renderSidebarPriority(sorted, componentCompletes, readyToBuild, creepProbabilities);
                return;
            }

            sorted.forEach(([compId, finalScore], index) => {
                const item = ITEMS.find(i => i.id === compId);
                const completes = componentCompletes[compId];
                const isHighPriority = completes.length > 0;
                const prob = creepProbabilities[compId] || 0;
                const owned = inventory.components[compId] || 0;
                const baseScore = componentScores[compId];

                const priorityItem = document.createElement('div');
                priorityItem.className = 'priority-item' + (isHighPriority ? ' high-priority' : '');

                // Calculate how many more are needed for selected items
                let neededCount = 0;
                selectedCombinedItems.forEach(itemId => {
                    const cItem = COMBINED_ITEMS.find(i => i.id === itemId);
                    if (cItem.components.includes(compId)) {
                        if (cItem.components[0] === cItem.components[1]) {
                            // Needs 2 of same component
                            neededCount += Math.max(0, 2 - owned);
                        } else {
                            // Needs 1 of each
                            neededCount += 1;
                        }
                    }
                });
                neededCount = Math.max(0, neededCount - owned);

                // Probability color coding
                let probClass;
                if (prob < 5) {
                    probClass = 'low-chance';
                } else if (prob > 12) {
                    probClass = 'high-chance';
                } else {
                    probClass = 'medium-chance';
                }

                // Build the info rows
                let infoHtml = '';

                // Row 1: Owned and Needed
                infoHtml += `<div class="priority-stats">`;
                infoHtml += `<span class="stat-item">Have: <strong>${owned}</strong></span>`;
                infoHtml += `<span class="stat-divider">|</span>`;
                infoHtml += `<span class="stat-item">Need: <strong class="${neededCount > 0 ? 'need-highlight' : ''}">${neededCount}</strong></span>`;
                infoHtml += `<span class="stat-divider">|</span>`;
                infoHtml += `<span class="stat-item ${probClass}">Creep: <strong>${prob.toFixed(0)}%</strong></span>`;
                infoHtml += `</div>`;

                // Row 2: Completes or Builds toward
                if (isHighPriority) {
                    infoHtml += `<div class="priority-completes">Finishes: ${completes.join(', ')}</div>`;
                } else {
                    const itemCount = Math.ceil(baseScore);
                    infoHtml += `<div class="priority-toward">Builds toward ${itemCount} item${itemCount > 1 ? 's' : ''}</div>`;
                }

                priorityItem.innerHTML = `
                    <div class="priority-rank">#${index + 1}</div>
                    <div class="item-image-container">
                        <img class="item-image" src="${item.image}" alt="${item.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="item-emoji" style="display:none; font-size:1.4rem; align-items:center; justify-content:center;">${item.emoji}</div>
                    </div>
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        ${infoHtml}
                    </div>
                `;
                priorityList.appendChild(priorityItem);
            });

            // Also render to sidebar (same full information)
            renderSidebarPriority(sorted, componentCompletes, readyToBuild, creepProbabilities, componentScores);
        }

        function renderSidebarPriority(sorted, componentCompletes, readyToBuild, creepProbabilities, componentScores) {
            const sidebarList = document.getElementById('sidebarPriorityList');
            sidebarList.innerHTML = '';

            // Show ready-to-build items first
            if (readyToBuild.length > 0) {
                const readyDiv = document.createElement('div');
                readyDiv.className = 'sidebar-ready-banner';
                readyDiv.innerHTML = `
                    <div class="label">Ready to Build:</div>
                    <div class="items">${readyToBuild.join(', ')}</div>
                `;
                sidebarList.appendChild(readyDiv);
            }

            if (sorted.length === 0) {
                if (readyToBuild.length === 0) {
                    sidebarList.innerHTML = '<span style="color: #a0a0a0; font-size: 0.85rem;">All items ready!</span>';
                }
                return;
            }

            // Show priority items with full information (matching main display)
            sorted.forEach(([compId, finalScore], index) => {
                const item = ITEMS.find(i => i.id === compId);
                const completes = componentCompletes[compId];
                const isHighPriority = completes.length > 0;
                const prob = creepProbabilities[compId] || 0;
                const owned = inventory.components[compId] || 0;
                const baseScore = componentScores[compId];

                // Calculate how many more are needed for selected items
                let neededCount = 0;
                selectedCombinedItems.forEach(itemId => {
                    const cItem = COMBINED_ITEMS.find(i => i.id === itemId);
                    if (cItem.components.includes(compId)) {
                        if (cItem.components[0] === cItem.components[1]) {
                            neededCount += Math.max(0, 2 - owned);
                        } else {
                            neededCount += 1;
                        }
                    }
                });
                neededCount = Math.max(0, neededCount - owned);

                // Probability color coding
                let probClass;
                if (prob < 5) {
                    probClass = 'low-chance';
                } else if (prob > 12) {
                    probClass = 'high-chance';
                } else {
                    probClass = 'medium-chance';
                }

                const div = document.createElement('div');
                div.className = 'sidebar-priority-item' + (isHighPriority ? ' high-priority' : '');

                // Build details HTML (Have/Need/Creep)
                let statsHtml = `<span class="stat-item">Have: <strong>${owned}</strong></span>`;
                statsHtml += ` <span class="stat-divider">|</span> `;
                statsHtml += `<span class="stat-item">Need: <strong class="${neededCount > 0 ? 'need-highlight' : ''}">${neededCount}</strong></span>`;
                statsHtml += ` <span class="stat-divider">|</span> `;
                statsHtml += `<span class="stat-item ${probClass}">Creep: <strong>${prob.toFixed(0)}%</strong></span>`;

                // Second row: Finishes or Builds toward
                let row2Html = '';
                if (isHighPriority) {
                    row2Html = `<div class="details"><span class="finish">Finishes: ${completes.join(', ')}</span></div>`;
                } else {
                    const itemCount = Math.ceil(baseScore);
                    row2Html = `<div class="details" style="color: #7f8c8d;">Builds toward ${itemCount} item${itemCount > 1 ? 's' : ''}</div>`;
                }

                div.innerHTML = `
                    <span class="rank">#${index + 1}</span>
                    <img src="${item.image}" alt="${item.name}" onerror="this.style.display='none';">
                    <div class="info">
                        <div class="name">${item.name}</div>
                        <div class="details">${statsHtml}</div>
                        ${row2Html}
                    </div>
                `;
                sidebarList.appendChild(div);
            });
        }

        // ==================== SAVED COMPS SYSTEM ====================

        let modalSelectedItems = new Set(); // Track items selected in modal

        function renderCompsSidebar() {
            const list = document.getElementById('compsList');
            if (!list) return;

            if (savedComps.length === 0) {
                list.innerHTML = '<div class="no-comps-msg">No saved comps yet</div>';
                return;
            }

            list.innerHTML = savedComps.map(comp => {
                // Check if this comp is currently active (matches selected items)
                const isActive = comp.items.length > 0 &&
                    comp.items.length === selectedCombinedItems.size &&
                    comp.items.every(id => selectedCombinedItems.has(id));

                // Build items preview (show first 12 items)
                const previewItems = comp.items.slice(0, 15);
                const itemsHtml = previewItems.map(itemId => {
                    const item = COMBINED_ITEMS.find(i => i.id === itemId);
                    if (!item) return '';
                    return `<img src="${item.image}" alt="${item.name}" title="${item.name}" onerror="this.style.display='none'">`;
                }).join('');

                return `
                    <div class="comp-card ${isActive ? 'active' : ''}" onclick="applyComp('${comp.id}')">
                        <div class="comp-card-header">
                            <span class="comp-name">${comp.name}</span>
                            <button class="comp-edit-btn" onclick="event.stopPropagation(); openCompModal('${comp.id}')">Edit</button>
                        </div>
                        <div class="comp-items-preview">${itemsHtml}</div>
                        <div class="comp-items-count">${comp.items.length} item${comp.items.length !== 1 ? 's' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function applyComp(compId) {
            const comp = savedComps.find(c => c.id === compId);
            if (!comp) return;

            // Clear current selection and apply comp items
            selectedCombinedItems.clear();
            comp.items.forEach(itemId => selectedCombinedItems.add(itemId));

            // Update all displays
            renderCombinedItems();
            updatePriorityDisplay();
            renderCompsSidebar();
            saveState();
        }

        function openCompModal(compId = null) {
            editingCompId = compId;
            modalSelectedItems.clear();

            const overlay = document.getElementById('compModalOverlay');
            const title = document.getElementById('compModalTitle');
            const nameInput = document.getElementById('compNameInput');
            const deleteBtn = document.getElementById('deleteCompBtn');

            if (compId) {
                // Editing existing comp
                const comp = savedComps.find(c => c.id === compId);
                if (comp) {
                    title.textContent = 'Edit Comp';
                    nameInput.value = comp.name;
                    comp.items.forEach(id => modalSelectedItems.add(id));
                    deleteBtn.style.display = 'block';
                }
            } else {
                // New comp
                title.textContent = 'New Comp';
                nameInput.value = '';
                deleteBtn.style.display = 'none';
            }

            renderCompItemSelector();
            overlay.classList.add('show');
            nameInput.focus();
        }

        function closeCompModal(event) {
            // If called from overlay click, only close if clicking the overlay itself
            if (event && event.target !== event.currentTarget) return;

            document.getElementById('compModalOverlay').classList.remove('show');
            editingCompId = null;
            modalSelectedItems.clear();
        }

        function renderCompItemSelector() {
            const selector = document.getElementById('compItemSelector');
            if (!selector) return;

            selector.innerHTML = COMBINED_ITEMS.map(item => {
                const isSelected = modalSelectedItems.has(item.id);
                return `
                    <div class="comp-item-option ${isSelected ? 'selected' : ''}" onclick="toggleModalItem('${item.id}')">
                        <img src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">
                        <span class="item-label">${item.name}</span>
                    </div>
                `;
            }).join('');
        }

        function toggleModalItem(itemId) {
            if (modalSelectedItems.has(itemId)) {
                modalSelectedItems.delete(itemId);
            } else {
                // Limit to 12 items
                if (modalSelectedItems.size >= 15) {
                    return; // Don't add more
                }
                modalSelectedItems.add(itemId);
            }
            renderCompItemSelector();
        }

        function saveComp() {
            const nameInput = document.getElementById('compNameInput');
            const name = nameInput.value.trim();

            if (!name) {
                nameInput.style.borderColor = '#e74c3c';
                nameInput.focus();
                return;
            }
            nameInput.style.borderColor = '';

            if (modalSelectedItems.size === 0) {
                alert('Please select at least one item');
                return;
            }

            if (editingCompId) {
                // Update existing comp
                const comp = savedComps.find(c => c.id === editingCompId);
                if (comp) {
                    comp.name = name;
                    comp.items = Array.from(modalSelectedItems);
                }
            } else {
                // Create new comp
                const newComp = {
                    id: 'comp-' + Date.now(),
                    name: name,
                    items: Array.from(modalSelectedItems)
                };
                savedComps.push(newComp);
            }

            closeCompModal();
            renderCompsSidebar();
            saveState();
        }

        function deleteComp() {
            if (!editingCompId) return;

            if (confirm('Delete this comp?')) {
                savedComps = savedComps.filter(c => c.id !== editingCompId);
                closeCompModal();
                renderCompsSidebar();
                saveState();
            }
        }

        // ==================== INVENTORY SYSTEM ====================

        function initInventory() {
            ITEMS.forEach(item => {
                inventory.components[item.id] = 0;
            });
            inventory.combinedItems = [];
        }

        function renderInventory() {
            renderInvComponents();
            renderBuildGrid();
            renderBuiltItems();
        }

        function renderInvComponents() {
            const grid = document.getElementById('invComponentGrid');
            if (!grid) return;

            grid.innerHTML = ITEMS.map(item => {
                const count = inventory.components[item.id] || 0;
                return `
                    <div class="inv-component">
                        <span class="comp-tooltip">${item.name}</span>
                        <img src="${item.image}" alt="${item.name}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <span class="comp-emoji" style="display:none;">${item.emoji}</span>
                        <div class="count ${count === 0 ? 'zero' : ''}">${count}</div>
                        <div class="inv-component-btns">
                            <button class="inv-btn inv-btn-minus" onclick="adjustComponent('${item.id}', -1)" ${count === 0 ? 'disabled' : ''}>‚àí</button>
                            <button class="inv-btn inv-btn-plus" onclick="adjustComponent('${item.id}', 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function adjustComponent(itemId, delta) {
            inventory.components[itemId] = Math.max(0, (inventory.components[itemId] || 0) + delta);
            renderInventory();
            renderCombinedItems(); // Update carousel advisor status
            updatePriorityDisplay();
        }

        function canBuildItem(itemId) {
            const item = COMBINED_ITEMS.find(i => i.id === itemId);
            if (!item) return false;
            const [c1, c2] = item.components;
            if (c1 === c2) {
                return (inventory.components[c1] || 0) >= 2;
            }
            return (inventory.components[c1] || 0) >= 1 && (inventory.components[c2] || 0) >= 1;
        }

        function getItemBuildStatus(itemId) {
            // Returns: 'built', 'ready', 'one-away', 'need-both'
            if (inventory.combinedItems.includes(itemId)) return 'built';

            const item = COMBINED_ITEMS.find(i => i.id === itemId);
            if (!item) return 'need-both';

            const [c1, c2] = item.components;
            const owned1 = inventory.components[c1] || 0;
            const owned2 = inventory.components[c2] || 0;

            if (c1 === c2) {
                if (owned1 >= 2) return 'ready';
                if (owned1 === 1) return 'one-away';
                return 'need-both';
            } else {
                if (owned1 > 0 && owned2 > 0) return 'ready';
                if (owned1 > 0 || owned2 > 0) return 'one-away';
                return 'need-both';
            }
        }

        function buildItem(itemId) {
            if (!canBuildItem(itemId)) return;

            const item = COMBINED_ITEMS.find(i => i.id === itemId);
            const [c1, c2] = item.components;

            if (c1 === c2) {
                inventory.components[c1] -= 2;
            } else {
                inventory.components[c1]--;
                inventory.components[c2]--;
            }

            inventory.combinedItems.push(itemId);

            // Uncheck from Carousel Advisor (user built it, usually doesn't need more)
            selectedCombinedItems.delete(itemId);

            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        function removeBuiltItem(index) {
            if (index < 0 || index >= inventory.combinedItems.length) return;

            // Get the item being removed
            const itemId = inventory.combinedItems[index];
            const item = COMBINED_ITEMS.find(i => i.id === itemId);

            // Return components to inventory
            if (item) {
                const [c1, c2] = item.components;
                inventory.components[c1] = (inventory.components[c1] || 0) + 1;
                inventory.components[c2] = (inventory.components[c2] || 0) + 1;
            }

            // Remove from built items
            inventory.combinedItems.splice(index, 1);

            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        function setBuildMode(mode) {
            buildMode = mode;

            // Update button states
            document.getElementById('buildModeBtn').classList.toggle('active', mode === 'build');
            document.getElementById('addModeBtn').classList.toggle('active', mode === 'add');

            // Update title and icon
            document.getElementById('buildModeIcon').textContent = mode === 'build' ? 'üî®' : 'üéÅ';
            document.getElementById('buildModeTitle').textContent = mode === 'build' ? 'Build Item' : 'Add Item';

            // Update hint
            document.getElementById('buildModeHint').textContent = mode === 'build'
                ? 'Click buildable items (green border)'
                : 'Click any item to add directly (purple)';

            renderBuildGrid();
        }

        function addItemDirectly(itemId) {
            // Add item to inventory without consuming components
            inventory.combinedItems.push(itemId);

            // Uncheck from Carousel Advisor (user got it, usually doesn't need more)
            selectedCombinedItems.delete(itemId);

            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        function renderBuildGrid() {
            const grid = document.getElementById('buildGrid');
            if (!grid) return;

            if (buildMode === 'add') {
                // Add mode: all items are clickable with purple styling
                grid.innerHTML = COMBINED_ITEMS.map(item => {
                    return `
                        <div class="build-item add-mode"
                             onclick="addItemDirectly('${item.id}')"
                             title="${item.name} (Click to add)">
                            <img src="${item.image}" alt="${item.name}"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="build-emoji" style="display:none;">üì¶</span>
                        </div>
                    `;
                }).join('');
            } else {
                // Build mode: only buildable items are clickable
                grid.innerHTML = COMBINED_ITEMS.map(item => {
                    const buildable = canBuildItem(item.id);
                    return `
                        <div class="build-item ${buildable ? 'buildable' : 'not-buildable'}"
                             onclick="${buildable ? `buildItem('${item.id}')` : ''}"
                             title="${item.name}${buildable ? ' (Click to build)' : ''}">
                            <img src="${item.image}" alt="${item.name}"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="build-emoji" style="display:none;">üì¶</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderBuiltItems() {
            const list = document.getElementById('builtItemsList');
            if (!list) return;

            if (inventory.combinedItems.length === 0) {
                list.innerHTML = '<span style="color: #a0a0a0; font-size: 0.85rem;">None yet</span>';
                return;
            }

            // Group items by id and count them
            const itemCounts = {};
            inventory.combinedItems.forEach((id, index) => {
                if (!itemCounts[id]) {
                    itemCounts[id] = { count: 0, indices: [] };
                }
                itemCounts[id].count++;
                itemCounts[id].indices.push(index);
            });

            list.innerHTML = Object.entries(itemCounts).map(([id, data]) => {
                const item = COMBINED_ITEMS.find(i => i.id === id);
                if (!item) return '';
                const lastIndex = data.indices[data.indices.length - 1]; // Remove most recent one
                const countText = data.count > 1 ? ` x${data.count}` : '';
                return `
                    <div class="built-item">
                        <img src="${item.image}" alt="${item.name}"
                             onerror="this.style.display='none';">
                        <span>${item.name}${countText}</span>
                        <span class="remove-built" onclick="removeBuiltItem(${lastIndex})" title="Remove one (returns components)">√ó</span>
                    </div>
                `;
            }).join('');
        }

        function clearInventory() {
            if (!confirm('Clear all inventory? Components and built items will be reset.')) return;
            initInventory();
            renderInventory();
            renderCombinedItems();
            updatePriorityDisplay();
        }

        // ==================== REROLL CALCULATOR ====================

        function getEstimatedCopiesHeld(level, cost) {
            // Get total copies held by other 7 players for this tier
            const tierCopies = ESTIMATED_TIER_COPIES_HELD[level][cost - 1];
            // Divide by champions in tier to get average copies of ONE specific champ
            const champsInTier = CHAMPIONS_PER_TIER[cost];
            return tierCopies / champsInTier;
        }

        function updateEstimateDisplay() {
            const level = parseInt(document.getElementById('calcLevel').value);
            const cost = parseInt(document.getElementById('calcCost').value);
            const contested = parseFloat(document.getElementById('calcContested').value);
            const useEstimate = document.getElementById('calcUseEstimate').checked;

            const baseEstimate = getEstimatedCopiesHeld(level, cost);
            const estimate = Math.round(baseEstimate * contested * 10) / 10;

            const display = document.getElementById('estimateDisplay');
            const controls = document.getElementById('estimateControls');

            if (useEstimate) {
                controls.classList.remove('hidden');
                display.textContent = `Est. ~${estimate.toFixed(1)} copies held by others`;
            } else {
                controls.classList.add('hidden');
            }
        }

        function calculateReroll() {
            const level = parseInt(document.getElementById('calcLevel').value);
            const cost = parseInt(document.getElementById('calcCost').value);
            const owned = parseInt(document.getElementById('calcOwned').value) || 0;
            const knownOut = parseInt(document.getElementById('calcOut').value) || 0;
            const target = parseInt(document.getElementById('calcTarget').value);
            const gold = parseInt(document.getElementById('calcGold').value) || 0;
            const useEstimate = document.getElementById('calcUseEstimate').checked;
            const contested = parseFloat(document.getElementById('calcContested').value);

            // Calculate estimated copies held by others
            let estimatedOut = 0;
            if (useEstimate) {
                const baseEstimate = getEstimatedCopiesHeld(level, cost);
                estimatedOut = Math.round(baseEstimate * contested);
            }

            // Total copies out = known + estimated
            const out = knownOut + estimatedOut;

            const poolSize = POOL_SIZES[cost];
            const champsInTier = CHAMPIONS_PER_TIER[cost];
            const tierOdds = ROLL_ODDS[level][cost - 1] / 100;

            // Copies available in pool
            const copiesAvailable = Math.max(0, poolSize - owned - out);
            const copiesNeeded = Math.max(0, target - owned);

            // Total copies of all champions in this tier (also reduced by units held by others)
            const totalTierHeld = useEstimate ? ESTIMATED_TIER_COPIES_HELD[level][cost - 1] * contested : 0;
            const totalCopiesInTier = Math.max(1, poolSize * champsInTier - totalTierHeld);

            // Probability to see this specific champion in one shop slot
            const probPerSlot = tierOdds * (copiesAvailable / Math.max(1, totalCopiesInTier));

            // 5 slots per shop, probability to see at least 1 copy per roll
            const probPerRoll = 1 - Math.pow(1 - probPerSlot, 5);

            // Number of rolls with given gold (2g per roll)
            const rolls = Math.floor(gold / 2);

            // Probability to hit at least copiesNeeded with given rolls
            // Using binomial approximation for expected copies
            const expectedCopies = rolls * 5 * probPerSlot;

            // Probability to hit target (simplified using Poisson approximation for rare events)
            let probToHit;
            if (copiesNeeded <= 0) {
                probToHit = 1;
            } else if (probPerSlot === 0 || copiesAvailable < copiesNeeded) {
                probToHit = 0;
            } else {
                // Cumulative probability using normal approximation
                const mean = expectedCopies;
                const variance = rolls * 5 * probPerSlot * (1 - probPerSlot);
                const stdDev = Math.sqrt(variance);

                if (stdDev > 0) {
                    const z = (copiesNeeded - 0.5 - mean) / stdDev;
                    probToHit = 1 - normalCDF(z);
                } else {
                    probToHit = mean >= copiesNeeded ? 1 : 0;
                }
            }

            probToHit = Math.max(0, Math.min(1, probToHit));

            // Expected gold to hit (if probability per roll > 0)
            let expectedGold;
            if (probPerRoll > 0 && copiesNeeded > 0) {
                const avgRollsPerCopy = 1 / (5 * probPerSlot);
                expectedGold = Math.ceil(avgRollsPerCopy * copiesNeeded * 2);
            } else if (copiesNeeded <= 0) {
                expectedGold = 0;
            } else {
                expectedGold = Infinity;
            }

            // Display results
            displayResults({
                probToHit: probToHit * 100,
                expectedGold: expectedGold,
                expectedCopies: expectedCopies,
                copiesNeeded: copiesNeeded,
                copiesAvailable: copiesAvailable,
                probPerSlot: probPerSlot * 100,
                tierOdds: tierOdds * 100,
                knownOut: knownOut,
                estimatedOut: estimatedOut,
                totalOut: out
            });
        }

        function normalCDF(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;

            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);

            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

            return 0.5 * (1.0 + sign * y);
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('calcResults');
            const resultGrid = document.getElementById('resultGrid');
            const probFill = document.getElementById('probabilityFill');

            resultsDiv.style.display = 'block';

            const probClass = data.probToHit >= 70 ? '' : data.probToHit >= 40 ? 'warning' : 'danger';
            const goldDisplay = data.expectedGold === Infinity ? '‚àû' : data.expectedGold + 'g';
            const goldClass = data.expectedGold <= 30 ? '' : data.expectedGold <= 60 ? 'warning' : 'danger';

            // Build copies out display with breakdown
            let copiesOutHtml = `<div class="value">${data.totalOut}</div>`;
            if (data.estimatedOut > 0) {
                copiesOutHtml = `
                    <div class="value">${data.totalOut}</div>
                    <div class="sublabel">${data.knownOut} known + ${data.estimatedOut} est.</div>
                `;
            }

            resultGrid.innerHTML = `
                <div class="result-card">
                    <div class="label">Chance to Hit</div>
                    <div class="value ${probClass}">${data.probToHit.toFixed(1)}%</div>
                </div>
                <div class="result-card">
                    <div class="label">Expected Gold Needed</div>
                    <div class="value ${goldClass}">${goldDisplay}</div>
                </div>
                <div class="result-card">
                    <div class="label">Expected Copies Found</div>
                    <div class="value">${data.expectedCopies.toFixed(1)}</div>
                </div>
                <div class="result-card">
                    <div class="label">Copies Needed</div>
                    <div class="value">${data.copiesNeeded}</div>
                </div>
                <div class="result-card">
                    <div class="label">Copies in Pool</div>
                    <div class="value">${data.copiesAvailable}</div>
                </div>
                <div class="result-card">
                    <div class="label">Copies Out of Pool</div>
                    ${copiesOutHtml}
                </div>
                <div class="result-card">
                    <div class="label">Tier ${document.getElementById('calcCost').value} Odds at Lvl</div>
                    <div class="value">${data.tierOdds.toFixed(0)}%</div>
                </div>
            `;

            probFill.style.width = data.probToHit + '%';
            probFill.textContent = data.probToHit.toFixed(1) + '%';
        }

        // ==================== UTILITY ====================

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');

            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 3000);
        }

        // ==================== LOCAL STORAGE PERSISTENCE ====================

        const STORAGE_KEY = 'tft-toolkit-state';

        function saveState() {
            try {
                const state = {
                    currentRound,
                    itemCounts,
                    lootHistory,
                    gameHistory,
                    selectedCombinedItems: Array.from(selectedCombinedItems),
                    inventory,
                    buildMode,
                    savedComps
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('Failed to save state to localStorage:', e);
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;

                const state = JSON.parse(saved);

                // Restore Item Tracker state
                if (state.currentRound) currentRound = state.currentRound;
                if (state.itemCounts) itemCounts = state.itemCounts;
                if (state.lootHistory) lootHistory = state.lootHistory;
                if (state.gameHistory) gameHistory = state.gameHistory;

                // Restore Carousel Advisor state
                if (state.selectedCombinedItems) {
                    selectedCombinedItems = new Set(state.selectedCombinedItems);
                }

                // Restore Inventory state
                if (state.inventory) {
                    inventory = state.inventory;
                }
                if (state.buildMode) {
                    buildMode = state.buildMode;
                }

                // Restore Saved Comps
                if (state.savedComps) {
                    savedComps = state.savedComps;
                }

                return true;
            } catch (e) {
                console.warn('Failed to load state from localStorage:', e);
                return false;
            }
        }

        // Auto-save on state changes - wrap key functions
        function wrapWithSave(fn) {
            return function(...args) {
                const result = fn.apply(this, args);
                saveState();
                return result;
            };
        }

        // ==================== INITIALIZATION ====================

        function initRerollCalculator() {
            // Add event listeners for automatic estimate updates
            const levelSelect = document.getElementById('calcLevel');
            const costSelect = document.getElementById('calcCost');
            const contestedSelect = document.getElementById('calcContested');
            const useEstimateCheckbox = document.getElementById('calcUseEstimate');

            // Update estimate display when any of these change
            levelSelect.addEventListener('change', updateEstimateDisplay);
            costSelect.addEventListener('change', updateEstimateDisplay);
            contestedSelect.addEventListener('change', updateEstimateDisplay);
            useEstimateCheckbox.addEventListener('change', updateEstimateDisplay);

            // Initialize the estimate display on page load
            updateEstimateDisplay();
        }

        // Try to load saved state first
        const hadSavedState = loadState();

        if (!hadSavedState) {
            // No saved state - initialize fresh
            initInventory();
        }

        initTracker(hadSavedState); // Skip reset if we loaded state
        initCarouselAdvisor();
        initRerollCalculator();
        renderInventory();
        renderCompsSidebar();

        // If we had saved state, update all displays
        if (hadSavedState) {
            document.getElementById('currentRound').textContent = currentRound;
            renderItems();
            updateProbabilities();
            updateUndoButton();
            updateHistoryDisplay();
            renderCombinedItems();
            updatePriorityDisplay();
            setBuildMode(buildMode);
            renderCompsSidebar();
        }

        // Auto-save after any state-changing action
        // We'll add save calls to key functions
        const originalLootItem = lootItem;
        lootItem = function(itemId) {
            originalLootItem(itemId);
            saveState();
        };

        const originalUndoLastLoot = undoLastLoot;
        undoLastLoot = function() {
            originalUndoLastLoot();
            saveState();
        };

        const originalNextRound = nextRound;
        nextRound = function() {
            originalNextRound();
            saveState();
        };

        const originalResetGame = resetGame;
        resetGame = function() {
            originalResetGame();
            saveState();
        };

        const originalToggleCombinedItem = toggleCombinedItem;
        toggleCombinedItem = function(itemId) {
            originalToggleCombinedItem(itemId);
            saveState();
        };

        const originalClearSelectedItems = clearSelectedItems;
        clearSelectedItems = function() {
            originalClearSelectedItems();
            saveState();
        };

        const originalAdjustComponent = adjustComponent;
        adjustComponent = function(itemId, delta) {
            originalAdjustComponent(itemId, delta);
            saveState();
        };

        const originalBuildItem = buildItem;
        buildItem = function(itemId) {
            originalBuildItem(itemId);
            saveState();
        };

        const originalAddItemDirectly = addItemDirectly;
        addItemDirectly = function(itemId) {
            originalAddItemDirectly(itemId);
            saveState();
        };

        const originalRemoveBuiltItem = removeBuiltItem;
        removeBuiltItem = function(index) {
            originalRemoveBuiltItem(index);
            saveState();
        };

        const originalSetBuildMode = setBuildMode;
        setBuildMode = function(mode) {
            originalSetBuildMode(mode);
            saveState();
        };

        const originalClearInventory = clearInventory;
        clearInventory = function() {
            originalClearInventory();
            saveState();
        };
    </script>
</body>
</html>
